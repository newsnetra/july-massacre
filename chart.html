<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet" />

<!-- Container -->
<div class="heatmap-section">
  <h2 class="heatmap-title">Geographic Distribution of Violence</h2>
  <p class="heatmap-subtitle">
    Spatial analysis of fatalities across districts and administrative zones during the July Massacre
  </p>
  <div id="heatmapChart" style="width:100%; max-width:1000px; height:600px;"></div>
</div>

<!-- Styles -->
<style>
.heatmap-section {
  font-family: 'utopia-std', serif;
  padding: 2rem 1rem;
  max-width: 1000px;
  margin: auto;
  background: none;
  border: none;
}
.heatmap-title {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.3rem;
}
.heatmap-subtitle {
  font-size: 1rem;
  margin-bottom: 1rem;
}
#heatmapChart .slice.cursor-pointer {
  cursor: pointer;
}
.heatmap-section text.slicetext {
  font-family: 'IBM Plex Mono', monospace !important;
}
</style>
<script>
const values = [107, 66, 62, 56, 40, 36, 25, 19];
const labels = ["Wari", "Uttara", "Mirpur", "Gulshan", "Motijhil",
                "Tejgaon", "Ramna", "Lalbagh"];

const data = [{
  type: "treemap",
  labels,
  parents: Array(values.length).fill(""),
  values,
  textinfo: "label+value",
  hoverinfo: "skip",                        // no hover events
  marker: {
    colors: values,
    opacity: 0,                             // (ignored by treemap, safe to keep)
    colorscale: [[0,'yellow'],[0.5,'orange'],[1,'red']],
    colorbar: {
      title: "Fatalities",
      orientation: "h",
      x: 0.5, xanchor: "center", y: 1.15,
      len: 0.8, thickness: 20, outlinewidth: 0,
      tickfont:  { family: "IBM Plex Mono", size: 12, color: "#000" },
      titlefont: { family: "IBM Plex Mono", size: 12, color: "#000" }
    },
    line: { width: 0 }
  }
}];

const layout  = {
  margin: { t:0, l:0, r:0, b:0 },
  paper_bgcolor: "rgba(0,0,0,0)",
  plot_bgcolor:  "rgba(0,0,0,0)"
};

const config  = {
  displayModeBar: false,
  displaylogo:   false,
  responsive:    true,
  staticPlot:    true                    // disables hover / click
};

Plotly.newPlot("heatmapChart", data, layout, config).then(() => {

  /* centre every label */
  document.querySelectorAll('#heatmapChart .slice').forEach(slice => {
    const path = slice.querySelector('path.surface');
    const txt  = slice.querySelector('text.slicetext');
    if (path && txt) {
      const m = path.getAttribute('d').match(/M([\d.]+),([\d.]+)L([\d.]+),([\d.]+)/);
      if (m) {
        const [,x1,y1,x2,y2] = m.map(Number);
        const cx = (x1+x2)/2, cy = (y1+y2)/2;
        requestAnimationFrame(() => {
          const h = txt.getBBox().height || 0;
          txt.setAttribute('transform', `translate(${cx},${cy+h/2})`);
          txt.setAttribute('text-anchor', 'middle');
        });
      }
    }
  });

  /* one-time style cleanup */
  document.querySelectorAll('#heatmapChart path.surface').forEach((p, idx) => {
    let s = p.getAttribute('style') || '';

    /* remove strokes */
    s = s
      .replace(/stroke:\s*[^;]+;/gi,'')
      .replace(/stroke-width:\s*[^;]+;/gi,'')
      .replace(/stroke-opacity:\s*[^;]+;/gi,'');

    /* if this path is the dark-grey filler block, make it transparent */
    if (/rgb\(68,\s*68,\s*68\)/i.test(s)) {
      s = s.replace(/rgb\(68,\s*68,\s*68\)/gi,'transparent');
      s = /fill-opacity:/i.test(s)
            ? s.replace(/fill-opacity:\s*[^;]+;/i,'fill-opacity: 0;')
            : s + ' fill-opacity: 0;';
    }

    p.setAttribute('style', s.trim());
  });
});
</script>
